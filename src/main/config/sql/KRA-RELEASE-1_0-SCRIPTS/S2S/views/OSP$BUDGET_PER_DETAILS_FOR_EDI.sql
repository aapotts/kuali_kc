
  CREATE OR REPLACE VIEW OSP$BUDGET_PER_DETAILS_FOR_EDI (PROPOSAL_NUMBER, BUDGET_PERIOD, LINE_ITEM_NUMBER, PERSON_NUMBER, RATE_NUMBER, PERSON_ID, JOB_CODE, START_DATE, END_DATE, PERIOD_TYPE, LINE_ITEM_DESCRIPTION, SEQUENCE_NUMBER, SALARY_REQUESTED, PERCENT_CHARGED, PERCENT_EFFORT, COST_SHARING_PERCENT, COST_SHARING_AMOUNT, UNDERRECOVERY_AMOUNT, ON_OFF_CAMPUS_FLAG, APPLY_IN_RATE_FLAG, BUDGET_JUSTIFICATION, UPDATE_TIMESTAMP, UPDATE_USER) AS 
  SELECT
A.PROPOSAL_NUMBER PROPOSAL_NUMBER, 
A.BUDGET_PERIOD BUDGET_PERIOD , 
A.LINE_ITEM_NUMBER LINE_ITEM_NUMBER, 
'1' PERSON_NUMBER,
ROWNUM RATE_NUMBER, 
'999999999' PERSON_ID,
'000000' JOB_CODE,
A.START_DATE START_DATE,
A.END_DATE END_DATE,
'CC' PERIOD_TYPE,
B.LINE_ITEM_DESCRIPTION LINE_ITEM_DESCRIPTION,
'0' SEQUENCE_NUMBER,
A.SALARY_REQUESTED, 
'100.00' PERCENT_CHARGED,
'100.00' PERCENT_EFFORT,
'0.00' COST_SHARING_PERCENT,
A.COST_SHARING_AMOUNT, 
A.UNDERRECOVERY_AMOUNT, 
B.ON_OFF_CAMPUS_FLAG ON_OFF_CAMPUS_FLAG,
B.APPLY_IN_RATE_FLAG APPLY_IN_RATE_FLAG, -- Check to see if there is any logic for this column
B.BUDGET_JUSTIFICATION BUDGET_JUSTIFICATION,
B.UPDATE_TIMESTAMP UPDATE_TIMESTAMP,
B.UPDATE_USER UPDATE_USER
FROM 
(SELECT
PROPOSAL_NUMBER, 
VERSION_NUMBER,
BUDGET_PERIOD , 
LINE_ITEM_NUMBER, 
START_DATE,
END_DATE,
BASE_COST_SHARING COST_SHARING_AMOUNT,
SALARY_REQUESTED SALARY_REQUESTED,
UNDERRECOVERY_AMOUNT UNDERRECOVERY_AMOUNT
FROM BUDGET_PER_DET_RATE_AND_BASE X, (SELECT RATE_CLASS_CODE, RATE_TYPE_CODE
FROM VALID_CALC_TYPES WHERE RATE_CLASS_TYPE IN ('E', 'V')) Y
WHERE X.rate_class_code = Y.rate_class_code AND X.RATE_TYPE_CODE = Y.RATE_TYPE_CODE 
--GROUP BY PROPOSAL_NUMBER,VERSION_NUMBER,BUDGET_PERIOD,LINE_ITEM_NUMBER,START_DATE,END_DATE
UNION
SELECT
N.PROPOSAL_NUMBER, 
N.VERSION_NUMBER,
N.BUDGET_PERIOD , 
N.LINE_ITEM_NUMBER, 
N.START_DATE,
N.END_DATE,
SUM(BASE_COST_SHARING) COST_SHARING_AMOUNT,
SUM(SALARY_REQUESTED) SALARY_REQUESTED,
SUM(UNDERRECOVERY_AMOUNT) UNDERRECOVERY_AMOUNT
FROM BUDGET_PER_DET_RATE_AND_BASE N, (SELECT
PROPOSAL_NUMBER, 
VERSION_NUMBER,
BUDGET_PERIOD , 
LINE_ITEM_NUMBER, 
START_DATE,
END_DATE,
RATE_CLASS_CODE,
RATE_TYPE_CODE
FROM BUDGET_PER_DET_RATE_AND_BASE X 
MINUS
SELECT
PROPOSAL_NUMBER, 
VERSION_NUMBER,
BUDGET_PERIOD , 
LINE_ITEM_NUMBER,
START_DATE,
END_DATE,
X.RATE_CLASS_CODE,
X.RATE_TYPE_CODE
FROM BUDGET_PER_DET_RATE_AND_BASE X, (SELECT RATE_CLASS_CODE, RATE_TYPE_CODE
FROM VALID_CALC_TYPES WHERE RATE_CLASS_TYPE IN ('E', 'V')) Y
WHERE X.rate_class_code = Y.rate_class_code AND X.RATE_TYPE_CODE = Y.RATE_TYPE_CODE) M
WHERE M.PROPOSAL_NUMBER = N.PROPOSAL_NUMBER AND
M.VERSION_NUMBER = N.VERSION_NUMBER AND
M.BUDGET_PERIOD = N.BUDGET_PERIOD AND M.LINE_ITEM_NUMBER = N.LINE_ITEM_NUMBER AND
M.rate_class_code = N.rate_class_code AND M.RATE_TYPE_CODE = N.RATE_TYPE_CODE
GROUP BY N.PROPOSAL_NUMBER,N.VERSION_NUMBER,N.BUDGET_PERIOD,N.LINE_ITEM_NUMBER,N.START_DATE,N.END_DATE) A, 
BUDGET_DETAILS B
WHERE B.PROPOSAL_NUMBER = A.PROPOSAL_NUMBER AND
B.VERSION_NUMBER = A.VERSION_NUMBER AND
B.BUDGET_PERIOD = A.BUDGET_PERIOD AND B.LINE_ITEM_NUMBER = A.LINE_ITEM_NUMBER;
 