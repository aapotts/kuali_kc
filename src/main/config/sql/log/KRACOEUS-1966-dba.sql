-- Upgrade script for Rice 0.9.3 for development and system databases.
-- Use version b for unit test databases.

-- KCB

CREATE SEQUENCE KCB_MESSAGES_SEQ INCREMENT BY 1 START WITH 1000;
CREATE SEQUENCE KCB_MSG_DELIVS_SEQ INCREMENT BY 1 START WITH 1000;
CREATE SEQUENCE KCB_RECIP_DELIVS_SEQ INCREMENT BY 1 START WITH 1000;
CREATE SEQUENCE KCB_RECIP_PREFS_SEQ INCREMENT BY 1 START WITH 1000;

CREATE TABLE KCB_MESSAGES
(
    ID                  NUMBER(8) NOT NULL,
    ORIGIN_ID           VARCHAR2(128) NULL,
    DELIVERY_TYPE       VARCHAR2(500) NOT NULL,
    CREATED_DATETIME    TIMESTAMP NOT NULL,
    TITLE               VARCHAR2(255) NULL,
    CHANNEL             VARCHAR2(300) NOT NULL,
    PRODUCER            VARCHAR2(300) NULL,
    CONTENT             CLOB NOT NULL,
    CONTENT_TYPE        VARCHAR2(128) NULL,
    URL                 VARCHAR2(512) NULL,
    USER_RECIPIENT_ID   VARCHAR2(300) NOT NULL,
    DB_LOCK_VER_NBR     INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT KCB_MESSAGES_PK PRIMARY KEY (ID)
);

CREATE TABLE KCB_MSG_DELIVS
(
    ID                      NUMBER(8) NOT NULL,
    MESSAGE_ID              NUMBER(8) NOT NULL,
    DELIVERER_TYPE_NAME     VARCHAR2(500) NOT NULL,
    DELIVERER_SYSTEM_ID     VARCHAR2(300),
    DELIVERY_STATUS         VARCHAR2(15) NOT NULL,
    LOCKED_DATE             TIMESTAMP NULL,
    DB_LOCK_VER_NBR         INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT KCB_MSG_DELIVS_PK PRIMARY KEY (ID)
);

CREATE TABLE KCB_RECIP_DELIVS
(
    ID                  NUMBER(8) NOT NULL,
    RECIPIENT_ID        VARCHAR2(300) NOT NULL,
    CHANNEL             VARCHAR2(300) NOT NULL,
    DELIVERER_NAME      VARCHAR2(300) NOT NULL,
    DB_LOCK_VER_NBR     INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT KCB_RECIP_DELIVS_PK PRIMARY KEY (ID)
);

CREATE TABLE KCB_RECIP_PREFS
(
    ID                  NUMBER(8) NOT NULL,
    RECIPIENT_ID        VARCHAR2(300) NOT NULL,
    PROPERTY            VARCHAR2(300) NOT NULL,
    VALUE               VARCHAR2(1000) NOT NULL,
    DB_LOCK_VER_NBR     INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT KCB_RECIP_PREFS_PK PRIMARY KEY (ID)
);

ALTER TABLE KCB_MESSAGES
ADD CONSTRAINT KCB_MESSAGES_UK1 UNIQUE
(
ORIGIN_ID
) ENABLE;

ALTER TABLE KCB_MSG_DELIVS
ADD CONSTRAINT KCB_MSG_DELIVS_UK1 UNIQUE
(
MESSAGE_ID,
DELIVERER_TYPE_NAME
) ENABLE;


ALTER TABLE KCB_MSG_DELIVS
ADD CONSTRAINT KCB_MSG_DELIVS_FK1 FOREIGN KEY
(
MESSAGE_ID
)
REFERENCES KCB_MESSAGES
(
ID
) ENABLE;

ALTER TABLE KCB_RECIP_DELIVS
ADD CONSTRAINT KCB_RECIP_DELIVS_UK1 UNIQUE
(
    RECIPIENT_ID,
    CHANNEL,
    DELIVERER_NAME
) ENABLE;

ALTER TABLE KCB_RECIP_PREFS
ADD CONSTRAINT KCB_RECIP_PREFS_UK1 UNIQUE
(
    RECIPIENT_ID,
    PROPERTY
) ENABLE;

alter table KCB_MSG_DELIVS add PROCESS_COUNT NUMBER(4) DEFAULT 0 NOT NULL;

CREATE INDEX KCB_MSG_DELIVSI1 ON KCB_MSG_DELIVS (MESSAGE_ID);

-- KEN

ALTER TABLE NOTIFICATION_CONTENT_TYPES
DROP CONSTRAINT NOTIFICATION_CONTENT_TYPE_UK1;

--index is dropped when constraint is dropped.
--drop index NOTIFICATION_CONTENT_TYPE_UK1;

ALTER TABLE NOTIFICATION_CONTENT_TYPES
ADD CONSTRAINT NOTIFICATION_CONTENT_TYPE_UK1 UNIQUE
(
NAME, VERSION
) ENABLE;

drop table RECIPIENT_PREFERENCES cascade constraints;
DROP SEQUENCE RECIPIENT_PREFERENCES_SEQ;

drop table USER_DELIVERER_CONFIG cascade constraints;
DROP SEQUENCE USER_DELIVERER_CONFIG_SEQ;

ALTER TABLE NOTIFICATION_MSG_DELIVS 
DROP CONSTRAINT NOTIF_MSG_DELIVS_UK1;

ALTER TABLE NOTIFICATION_MSG_DELIVS
ADD CONSTRAINT NOTIF_MSG_DELIVS_UK1 UNIQUE
(
NOTIFICATION_ID,
USER_RECIPIENT_ID
) ENABLE;

-- alter table NOTIFICATION_MSG_DELIVS drop column MESSAGE_DELIVERY_TYPE_NAME;

CREATE INDEX KEN_NOTIFICATIONSI1 ON NOTIFICATIONS (CONTENT_TYPE_ID);
CREATE INDEX KEN_NOTIFICATIONSI2 ON NOTIFICATIONS (PRIORITY_ID);
CREATE INDEX KEN_NOTIFICATIONSI3 ON NOTIFICATIONS (PRODUCER_ID);
CREATE INDEX KEN_CHANNEL_PRODUCERSI1 ON NOTIFICATION_CHANNEL_PRODUCERS (CHANNEL_ID);
CREATE INDEX KEN_CHANNEL_PRODUCERSI2 ON NOTIFICATION_CHANNEL_PRODUCERS (PRODUCER_ID);
CREATE INDEX KEN_MSG_DELIVSI1 ON NOTIFICATION_MSG_DELIVS (NOTIFICATION_ID);
CREATE INDEX KEN_RECIPIENTSI1 ON NOTIFICATION_RECIPIENTS (NOTIFICATION_ID);
CREATE INDEX KEN_RECIPIENTS_LISTSI1 ON NOTIFICATION_RECIPIENTS_LISTS (CHANNEL_ID);
CREATE INDEX KEN_REVIEWERSI1 ON NOTIFICATION_REVIEWERS (CHANNEL_ID);
CREATE INDEX KEN_SENDERSI1 ON NOTIFICATION_SENDERS (NOTIFICATION_ID);
CREATE INDEX KEN_USER_CHAN_SUBSI1 ON USER_CHANNEL_SUBSCRIPTIONS (CHANNEL_ID);

-- KEW

-- A few additions for JPA inheritance --
alter table EN_USR_T add (DTYPE VARCHAR2(50));
alter table EN_DOC_HDR_T add (DTYPE VARCHAR2(50));
alter table EN_ACTN_ITM_T add (DTYPE VARCHAR2(50));
CREATE INDEX EN_ACTN_ITM_TI5 ON EN_ACTN_ITM_T (ACTN_ITM_PRSN_EN_ID, DLGN_TYP, DOC_HDR_ID);

-- Reporting Workgroup --
ALTER TABLE EN_DOC_TYP_T ADD RPT_WRKGRP_ID NUMBER(14) NULL;
CREATE INDEX EN_DOC_TYP_TI7 ON EN_DOC_TYP_T (RPT_WRKGRP_ID);

-- EDL Indexes
CREATE INDEX EN_DOC_DMP_TI1 ON EN_EDL_DMP_T (DOC_TYP_NM, DOC_HDR_ID);
CREATE INDEX EN_EDL_FIELD_DMP_TI1 ON EN_EDL_FIELD_DMP_T (DOC_HDR_ID, FLD_NM, FLD_VAL);
CREATE INDEX EN_EDL_FIELD_DMP_TI2 ON EN_EDL_FIELD_DMP_T (FLD_NM, FLD_VAL);

-- KNS

ALTER TABLE FS_ADHOC_RTE_ACTN_RECP_T DROP PRIMARY KEY;
ALTER TABLE FS_ADHOC_RTE_ACTN_RECP_T
ADD (PRIMARY KEY (
      ACTN_RQST_RECP_TYP_CD,ACTN_RQST_CD,ACTN_RQST_RECP_ID,FDOC_NBR ) );

delete from SH_PARM_T where SH_PARM_NMSPC_CD='KR-NS' and SH_PARM_NM='SESSION_TIMEOUT_WARNING_MESSAGE_TIME';
INSERT INTO SH_PARM_T(SH_PARM_NMSPC_CD, SH_PARM_DTL_TYP_CD, SH_PARM_NM, OBJ_ID, VER_NBR, SH_PARM_TYP_CD, SH_PARM_TXT, SH_PARM_DESC, SH_PARM_CONS_CD, WRKGRP_NM) VALUES('KR-NS', 'Document', 'SESSION_TIMEOUT_WARNING_MESSAGE_TIME', sys_guid(), 1, 'CONFG', '5', 'The number of minutes before a session expires that user should be warned when a document uses pessimistic locking.', 'A', 'KUALI_FMSOPS');

delete from SH_PARM_T where SH_PARM_NMSPC_CD='KR-NS' and SH_PARM_NM='PESSIMISTIC_LOCK_ADMIN_GROUP';
INSERT INTO SH_PARM_T(SH_PARM_NMSPC_CD, SH_PARM_DTL_TYP_CD, SH_PARM_NM, OBJ_ID, VER_NBR, SH_PARM_TYP_CD, SH_PARM_TXT, SH_PARM_DESC, SH_PARM_CONS_CD, WRKGRP_NM) VALUES('KR-NS', 'Document', 'PESSIMISTIC_LOCK_ADMIN_GROUP', sys_guid(), 1, 'AUTH', 'KUALI_ROLE_SUPERVISOR', 'Workgroup which can perform admin deletion and lookup functions for Pessimistic Locks.', 'A', 'KUALI_FMSOPS');

CREATE SEQUENCE FP_DOC_TYPE_ATTR_ID_SEQ INCREMENT BY 1 START WITH 1000;

CREATE TABLE FP_DOC_TYPE_ATTR_T (
        ID                             NUMBER(8) CONSTRAINT FP_DOC_TYPE_ATTR_TN1 NOT NULL,
        OBJ_ID                         VARCHAR2(36) DEFAULT SYS_GUID() CONSTRAINT FP_DOC_TYPE_ATTR_TN2 NOT NULL,
        VER_NBR                        NUMBER(8) DEFAULT 1 CONSTRAINT FP_DOC_TYPE_ATTR_TN3 NOT NULL,
        ACTIVE_IND                     CHAR(1) DEFAULT 'Y' CONSTRAINT FP_DOC_TYPE_ATTR_TN4 NOT NULL,
        DOC_TYP_ATTR_CD                VARCHAR2(100) CONSTRAINT FP_DOC_TYPE_ATTR_TN5 NOT NULL,
        DOC_TYP_ATTR_VAL               VARCHAR2(400),
        DOC_TYP_ATTR_LBL               VARCHAR2(400),
        FDOC_TYP_CD                    VARCHAR2(4) CONSTRAINT FP_DOC_TYPE_ATTR_TN6 NOT NULL,
     CONSTRAINT FP_DOC_TYPE_ATTR_TP1 PRIMARY KEY (
        ID) ,
     CONSTRAINT FP_DOC_TYPE_ATTR_TC0 UNIQUE (OBJ_ID) 
);

ALTER TABLE FP_DOC_TYPE_ATTR_T
ADD CONSTRAINT FP_DOC_TYPE_ATTR_TR1 FOREIGN KEY
(
FDOC_TYP_CD
)
REFERENCES FP_DOC_TYPE_T
(
FDOC_TYP_CD
) ENABLE;

---- FP_DOC_HEADER_T ADJUSTMENTS ----
drop index FP_DOC_HEADER_TI4;
alter table FP_DOC_HEADER_T drop column FDOC_STATUS_CD;
alter table FP_DOC_HEADER_T drop column FDOC_TOTAL_AMT;
alter table FP_DOC_HEADER_T drop column FDOC_IN_ERR_NBR;
alter table FP_DOC_HEADER_T drop column TEMP_DOC_FNL_DT;

---- FP_DOC_TYPE_T ADJUSTMENTS ----
drop index FP_DOC_TYPE_TI2;
alter table FP_DOC_TYPE_T drop constraint FP_DOC_TYPE_TR1;
alter table FP_DOC_TYPE_T drop column FDOC_GRP_CD;
alter table FP_DOC_TYPE_T drop column FIN_ELIM_ELGBL_CD;
alter table FP_DOC_TYPE_T drop column FDOC_RTNG_RULE_CD;
alter table FP_DOC_TYPE_T drop column FDOC_AUTOAPRV_DAYS;
alter table FP_DOC_TYPE_T drop column FDOC_BALANCED_CD;
alter table FP_DOC_TYPE_T drop column TRN_SCRBBR_OFST_GEN_IND;

---- KNS TABLE REMOVALS ----
drop table FP_DOC_GROUP_T cascade CONSTRAINTS;
drop table FP_DOC_STATUS_T cascade CONSTRAINTS;
drop table SH_LOCK_TYP_DESC_T cascade CONSTRAINTS;
drop table SH_LOCK_T cascade CONSTRAINTS;

